<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>学生课时管理系统</title>
    
    <!-- UI Library: Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Icons: FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Framework: Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');

        /* Custom Utilities */
        body { font-family: 'Inter', system-ui, -apple-system, sans-serif; }
        
        /* Vue Transitions */
        .fade-enter-active, .fade-leave-active { transition: opacity 0.2s ease; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
        
        .slide-up-enter-active, .slide-up-leave-active { transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); }
        .slide-up-enter-from, .slide-up-leave-to { transform: translateY(20px); opacity: 0; }

        .modal-enter-active, .modal-leave-active { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .modal-enter-from, .modal-leave-to { opacity: 0; transform: scale(0.95) translateY(10px); }

        /* Mobile optimization */
        body { -webkit-tap-highlight-color: transparent; }
        
        /* Hide scrollbar for clean look but allow scroll */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Safe area for iPhone X+ */
        .pt-safe { padding-top: env(safe-area-inset-top); }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }

        /* Hide uncompiled Vue templates */
        [v-cloak] { display: none !important; }
    </style>
</head>
<body class="bg-slate-50 md:bg-slate-100 text-slate-800 h-[100dvh] w-full flex flex-col items-center justify-center overflow-hidden antialiased selection:bg-indigo-100 selection:text-indigo-600">

    <!-- App Container: Mobile (full) -> Tablet (Card Style) -> Landscape (Wide) -->
    <div id="app" v-cloak class="flex flex-col h-full w-full max-w-md md:max-w-lg lg:max-w-5xl md:h-[95dvh] md:rounded-[2rem] md:shadow-2xl md:border md:border-white/50 bg-white relative overflow-hidden transition-all duration-300">
        
        <!-- Header (Global for List/Settings, but hidden in Detail view to allow custom header) -->
        <header v-if="currentView !== 'detail'" class="bg-white/80 backdrop-blur-md p-4 pt-safe z-20 flex justify-between items-center shrink-0 border-b border-gray-100 sticky top-0">
            <h1 class="text-xl font-extrabold flex items-center gap-2 bg-gradient-to-r from-indigo-600 to-violet-600 bg-clip-text text-transparent">
                <i class="fa-solid fa-layer-group text-indigo-600"></i> 课时管家
            </h1>
            <button @click="toggleSettings" class="w-10 h-10 flex items-center justify-center rounded-full hover:bg-gray-100 transition-colors text-gray-600 active:scale-95 touch-manipulation">
                <i class="fa-solid fa-gear text-lg"></i>
            </button>
        </header>

        <!-- Notification Toast -->
        <transition name="fade">
            <div v-if="notification.show" 
                 :class="['absolute top-20 left-1/2 transform -translate-x-1/2 px-5 py-3 rounded-2xl shadow-[0_8px_30px_rgb(0,0,0,0.12)] text-sm font-semibold z-50 flex items-center gap-3 min-w-[200px] justify-center backdrop-blur-md border', 
                 notification.type === 'error' ? 'bg-white/95 text-rose-600 border-rose-100' : 'bg-white/95 text-emerald-600 border-emerald-100']">
                <i :class="['fa-solid text-lg', notification.type === 'error' ? 'fa-circle-exclamation' : 'fa-circle-check']"></i>
                {{ notification.message }}
            </div>
        </transition>

        <!-- Main Content Area -->
        <main class="flex-1 overflow-hidden relative bg-slate-50">
            
            <!-- View: Student List (Now acts as "Switch Student" screen) -->
            <transition name="fade" mode="out-in">
                <div v-if="currentView === 'list'" key="list" class="h-full flex flex-col">
                    <!-- Search & Add Area -->
                    <div class="p-5 pb-2">
                        <div class="flex gap-4 mb-4">
                            <div class="relative flex-1 group">
                                <!-- Fixed: Use top-1/2 and translate-y-1/2 for perfect vertical centering -->
                                <i class="fa-solid fa-search absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400 group-focus-within:text-indigo-500 transition-colors pointer-events-none"></i>
                                <!-- Optimized Input: text-base prevents auto-zoom, inputmode for better keyboard -->
                                <input v-model="searchQuery" type="text" placeholder="搜索学生..." inputmode="search"
                                    class="w-full pl-11 pr-4 py-3 rounded-2xl bg-white border-none shadow-sm focus:ring-2 focus:ring-indigo-100 text-base font-medium placeholder-gray-400 transition-all">
                            </div>
                            <button @click="showAddModal = true" class="bg-indigo-600 text-white w-12 h-12 shrink-0 rounded-2xl shadow-lg shadow-indigo-200 hover:bg-indigo-700 hover:scale-105 active:scale-95 transition-all flex items-center justify-center touch-manipulation">
                                <i class="fa-solid fa-plus text-lg"></i>
                            </button>
                        </div>
                        
                        <!-- Status Bar -->
                        <div class="flex justify-between items-end px-1">
                            <div>
                                <h2 class="text-2xl font-bold text-slate-800 tracking-tight">选择学员</h2>
                                <p class="text-xs text-gray-400 font-medium mt-1">{{ filteredStudents.length }} 位在读学员</p>
                            </div>
                            <!-- Optimized Badge: text-xs for readability -->
                            <span v-if="isOnline" class="text-xs font-bold bg-emerald-50 text-emerald-600 px-2.5 py-1 rounded-full flex items-center gap-1.5 border border-emerald-100">
                                <span class="relative flex h-2 w-2">
                                  <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-emerald-400 opacity-75"></span>
                                  <span class="relative inline-flex rounded-full h-2 w-2 bg-emerald-500"></span>
                                </span>
                                云同步
                            </span>
                            <span v-else class="text-xs font-bold bg-amber-50 text-amber-600 px-2.5 py-1 rounded-full flex items-center gap-1.5 border border-amber-100">
                                <i class="fa-solid fa-wifi text-[9px]"></i> 本地模式
                            </span>
                        </div>
                    </div>

                    <!-- List Content -->
                    <div class="flex-1 overflow-y-auto p-5 pt-2 space-y-3 no-scrollbar pb-24 lg:grid lg:grid-cols-2 lg:gap-4 lg:space-y-0 lg:content-start">
                        <div v-if="filteredStudents.length === 0" class="flex flex-col items-center justify-center py-20 text-gray-300 lg:col-span-2">
                            <div class="w-20 h-20 bg-gray-100 rounded-full flex items-center justify-center mb-4">
                                <i class="fa-solid fa-user-graduate text-3xl text-gray-300"></i>
                            </div>
                            <p class="font-medium">暂无学生数据</p>
                            <button @click="showAddModal = true" class="mt-4 text-indigo-500 font-bold text-sm">点击添加</button>
                        </div>
                        
                        <div v-for="student in filteredStudents" :key="student.id" 
                             @click="selectStudent(student)"
                             class="group bg-white p-4 rounded-2xl shadow-[0_2px_8px_rgba(0,0,0,0.04)] hover:shadow-lg hover:shadow-indigo-100/50 active:scale-[0.98] transition-all cursor-pointer flex justify-between items-center border border-transparent hover:border-indigo-50">
                            <div class="flex items-center gap-4 flex-1">
                                <div class="w-12 h-12 rounded-2xl bg-gradient-to-br from-indigo-500 to-purple-600 text-white flex items-center justify-center font-bold text-xl shadow-md shadow-indigo-200">
                                    {{ student.name.charAt(0) }}
                                </div>
                                <div>
                                    <h3 class="font-bold text-slate-800 text-lg group-hover:text-indigo-600 transition-colors">{{ student.name }}</h3>
                                    <p class="text-[11px] text-gray-400 font-medium flex items-center gap-1">
                                        <i class="fa-regular fa-clock text-[10px]"></i> {{ getLastActivity(student) }}
                                    </p>
                                </div>
                            </div>
                            <div class="flex items-center gap-3">
                                <div class="text-right">
                                    <!-- Optimized Balance: text-3xl -->
                                    <span :class="['text-3xl font-black tracking-tight', getBalanceColor(student.balance)]">
                                        {{ student.balance }}
                                    </span>
                                    <p class="text-[10px] text-gray-400 font-bold uppercase tracking-wider">剩余</p>
                                </div>
                                <button @click.stop="openDeleteStudentModal(student)" class="relative z-10 w-10 h-10 flex items-center justify-center rounded-full text-gray-300 hover:text-rose-500 hover:bg-rose-50 transition-colors active:bg-rose-100 touch-manipulation">
                                    <i class="fa-regular fa-trash-can"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- View: Student Detail (HOME PAGE) -->
                <div v-else-if="currentView === 'detail'" key="detail" class="h-full flex flex-col bg-slate-50">
                    <!-- Custom Detail Header -->
                    <div class="px-4 py-3 pt-safe flex items-center justify-between sticky top-0 bg-white z-10 border-b border-gray-50">
                        <button @click="currentView = 'list'" class="flex items-center gap-2 bg-slate-100 hover:bg-slate-200 text-slate-700 px-3 py-2 rounded-xl transition-colors active:scale-95 touch-manipulation">
                            <i class="fa-solid fa-users text-xs"></i>
                            <span class="text-xs font-bold">更换学生</span>
                        </button>
                        
                        <div class="flex items-center gap-2">
                             <h2 class="text-lg font-bold text-slate-800">{{ currentStudent?.name }}</h2>
                             <button @click="startEditName" class="text-gray-300 hover:text-indigo-500 transition-colors p-2 rounded-full hover:bg-indigo-50">
                                <i class="fa-solid fa-pen text-xs"></i>
                             </button>
                        </div>
                        
                        <div class="flex gap-2">
                            <button @click="toggleSettings" class="w-9 h-9 flex items-center justify-center rounded-full hover:bg-gray-100 text-gray-400 hover:text-gray-600 transition-colors touch-manipulation">
                                <i class="fa-solid fa-gear"></i>
                            </button>
                        </div>
                    </div>

                    <div class="flex-1 overflow-y-auto no-scrollbar pb-safe">
                        <div class="lg:flex lg:items-start lg:p-6 lg:gap-8">
                            <!-- Left Column: Info & Actions (Grid on Desktop) -->
                            <div class="lg:w-96 lg:shrink-0 space-y-0 lg:space-y-6">
                                <!-- Hero Card -->
                                <div class="px-5 pt-4 pb-6 lg:p-0">
                                    <div class="bg-gradient-to-br from-indigo-600 via-violet-600 to-purple-600 rounded-3xl p-6 text-white shadow-xl shadow-indigo-200 relative overflow-hidden transition-all duration-500 hover:shadow-2xl hover:shadow-indigo-300">
                                        <!-- Decorative circles -->
                                        <div class="absolute top-0 right-0 -mr-8 -mt-8 w-32 h-32 rounded-full bg-white/10 blur-xl"></div>
                                        <div class="absolute bottom-0 left-0 -ml-8 -mb-8 w-24 h-24 rounded-full bg-white/10 blur-xl"></div>

                                        <div class="relative z-10 text-center">
                                            <p class="text-indigo-100 text-xs font-medium uppercase tracking-widest mb-2 opacity-80">当前剩余课时</p>
                                            <div class="text-7xl font-black tracking-tighter mb-4 drop-shadow-sm font-sans">
                                                {{ currentStudent?.balance }}
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Actions -->
                                <div class="px-5 mb-8 lg:p-0 lg:mb-0">
                                    <div class="grid grid-cols-2 gap-4">
                                        <!-- Prepaid Class (Full Width) -->
                                        <button @click="showRechargeModal = true" class="col-span-2 group bg-emerald-50 hover:bg-emerald-100 border border-emerald-100 text-emerald-700 py-4 px-6 rounded-2xl flex items-center justify-between transition-all active:scale-[0.97] shadow-sm touch-manipulation">
                                            <div class="flex items-center gap-3">
                                                <div class="w-10 h-10 rounded-full bg-emerald-500 text-white flex items-center justify-center shadow-emerald-200 shadow-md group-hover:scale-110 transition-transform shrink-0">
                                                    <i class="fa-solid fa-wallet"></i>
                                                </div>
                                                <span class="font-bold text-lg">预付课时</span>
                                            </div>
                                            <i class="fa-solid fa-chevron-right text-emerald-300 group-hover:text-emerald-500 transition-colors"></i>
                                        </button>
                                        
                                        <!-- Class Consumption 1 Hour -->
                                        <button @click="consumeClass(1)" 
                                            :disabled="currentStudent?.balance < 1"
                                            class="bg-white border border-gray-100 shadow-sm p-4 rounded-2xl flex flex-col items-center justify-center gap-2 hover:border-indigo-100 hover:shadow-md active:scale-[0.97] transition-all disabled:opacity-50 disabled:grayscale disabled:cursor-not-allowed h-24 touch-manipulation">
                                            <span class="text-lg font-bold text-slate-700">课销1小时</span>
                                        </button>

                                        <!-- Class Consumption 2 Hours -->
                                        <button @click="consumeClass(2)" 
                                            :disabled="currentStudent?.balance < 2"
                                            class="bg-white border border-gray-100 shadow-sm p-4 rounded-2xl flex flex-col items-center justify-center gap-2 hover:border-indigo-100 hover:shadow-md active:scale-[0.97] transition-all disabled:opacity-50 disabled:grayscale disabled:cursor-not-allowed h-24 touch-manipulation">
                                            <span class="text-lg font-bold text-slate-700">课销2小时</span>
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Right Column: History (Expanded on Desktop) -->
                            <div class="px-5 pb-10 lg:p-0 lg:flex-1">
                                <div class="flex items-center justify-between mb-4 px-1">
                                    <p class="text-sm font-bold text-gray-400 uppercase tracking-wider">课时记录</p>
                                </div>
                                <div class="space-y-3">
                                    <div v-if="sortedLogs.length === 0" class="flex flex-col items-center justify-center py-10 text-gray-300">
                                        <i class="fa-regular fa-clipboard text-3xl mb-2 opacity-20"></i>
                                        <span class="text-xs">暂无记录</span>
                                    </div>
                                    <!-- Fixed: Changed items-start to items-center for better icon alignment -->
                                    <div v-for="(log, idx) in sortedLogs" :key="idx" 
                                         class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 flex items-center justify-between group active:scale-[0.98] transition-all">
                                        
                                        <!-- Fixed: Removed mt-0.5 to allow true centering -->
                                        <div class="flex items-center gap-4">
                                            <!-- Icon -->
                                            <div :class="['w-10 h-10 rounded-full flex items-center justify-center text-white text-lg shadow-sm shrink-0', 
                                                log.amount > 0 ? 'bg-emerald-500 shadow-emerald-200' : 'bg-amber-500 shadow-amber-200']">
                                                <i :class="['fa-solid', log.amount > 0 ? 'fa-plus' : 'fa-minus']"></i>
                                            </div>
                                            
                                            <!-- Info -->
                                            <div class="flex flex-col">
                                                <div class="flex items-center gap-2">
                                                    <span class="font-bold text-slate-700 text-base">
                                                        {{ log.amount > 0 ? '预付课时' : '课程消耗' }}
                                                    </span>
                                                    <span :class="['font-black text-lg', log.amount > 0 ? 'text-emerald-500' : 'text-amber-500']">
                                                        {{ log.amount > 0 ? '+' : '' }}{{ log.amount }}
                                                    </span>
                                                </div>
                                                <div class="flex items-center gap-2 mt-1">
                                                     <span v-if="log.note" class="text-xs font-bold text-slate-500 bg-slate-100 px-2 py-1 rounded-md">
                                                        {{ log.note }}
                                                    </span>
                                                    <span class="text-xs text-gray-400 font-medium">
                                                       剩余课时: {{ log.snapshotBalance }}小时
                                                    </span>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Meta & Actions -->
                                        <div class="flex flex-col items-end justify-between self-stretch pl-2">
                                            <span class="text-[11px] text-gray-300 font-bold font-mono">{{ formatTime(log.timestamp) }}</span>
                                            
                                            <div class="flex gap-3 mt-auto mb-0.5">
                                                <button @click.stop="openEditLog(log)" class="text-gray-300 hover:text-indigo-500 transition-colors">
                                                    <i class="fa-solid fa-pen text-sm"></i>
                                                </button>
                                                <button @click.stop="promptDeleteLog(log)" class="text-gray-300 hover:text-rose-500 transition-colors">
                                                    <i class="fa-regular fa-trash-can text-sm"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- View: Settings -->
                <div v-else-if="currentView === 'settings'" key="settings" class="h-full flex flex-col bg-slate-50">
                    <div class="bg-white px-5 py-4 shadow-sm border-b border-gray-100 flex items-center gap-4 sticky top-0">
                        <button @click="toggleSettings" class="text-gray-400 hover:text-gray-800 transition-colors p-1">
                            <i class="fa-solid fa-xmark text-2xl"></i>
                        </button>
                        <h2 class="text-lg font-bold">系统设置</h2>
                    </div>
                    
                    <div class="p-5 space-y-5 overflow-y-auto lg:max-w-2xl lg:mx-auto lg:w-full">
                        <!-- Cloud Config -->
                        <section class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100">
                            <h3 class="font-bold text-slate-800 mb-2 flex items-center gap-2">
                                <i class="fa-brands fa-google text-indigo-500"></i> 数据同步
                            </h3>
                            <p class="text-xs text-gray-500 leading-relaxed mb-4">
                                请复制 Firebase 控制台 > 项目设置 > 常规 > 下方的 "SDK 设置与配置" 中的 <code>firebaseConfig</code> 对象内容并粘贴。
                                <button @click="currentView = 'help'" class="text-indigo-600 font-bold hover:underline inline-flex items-center gap-1 mt-1">
                                    <i class="fa-regular fa-circle-question"></i> 查看详细教程
                                </button>
                            </p>
                            <textarea v-model="firebaseConfigInput" rows="5" class="w-full text-xs font-mono p-3 bg-slate-900 text-emerald-400 rounded-xl mb-4 focus:outline-none focus:ring-2 focus:ring-indigo-500 resize-none shadow-inner" placeholder='{ "apiKey": "...", "authDomain": "...", ... }'></textarea>
                            <div class="flex gap-3">
                                <button @click="saveConfig" class="flex-1 bg-slate-800 text-white py-2.5 rounded-xl text-sm font-medium hover:bg-slate-900 transition-colors shadow-lg shadow-slate-200 active:scale-95 touch-manipulation">
                                    保存配置
                                </button>
                                <button @click="clearConfig" class="px-5 py-2.5 border border-gray-200 rounded-xl text-sm font-medium text-gray-500 hover:bg-gray-50 transition-colors active:scale-95 touch-manipulation">
                                    断开
                                </button>
                            </div>
                        </section>

                        <!-- Danger Zone -->
                        <section class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100">
                            <h3 class="font-bold text-slate-800 mb-4">高级选项</h3>
                            <div class="space-y-3">
                                <button @click="forceSyncToCloud" class="w-full py-3 px-4 bg-indigo-50 text-indigo-600 rounded-xl text-sm font-bold flex justify-between items-center hover:bg-indigo-100 transition-colors active:scale-[0.98]">
                                    <span><i class="fa-solid fa-cloud-arrow-up mr-2"></i> 强制同步至云端</span>
                                    <i class="fa-solid fa-chevron-right text-xs opacity-50"></i>
                                </button>
                                <button @click="resetAllData" class="w-full py-3 px-4 bg-rose-50 text-rose-600 rounded-xl text-sm font-bold flex justify-between items-center hover:bg-rose-100 transition-colors active:scale-[0.98]">
                                    <span><i class="fa-solid fa-triangle-exclamation mr-2"></i> 清空所有数据</span>
                                    <i class="fa-solid fa-chevron-right text-xs opacity-50"></i>
                                </button>
                            </div>
                        </section>
                    </div>
                    
                    <div class="p-4 text-center text-[10px] text-gray-300">
                        Version 1.2.0 • Designed for Vue
                    </div>
                </div>

                <!-- View: Help (Firebase Tutorial) -->
                <div v-else-if="currentView === 'help'" key="help" class="h-full flex flex-col bg-slate-50">
                    <div class="bg-white px-5 py-4 shadow-sm border-b border-gray-100 flex items-center gap-4 sticky top-0 z-10">
                        <button @click="currentView = 'settings'" class="text-gray-400 hover:text-gray-800 transition-colors p-1">
                            <i class="fa-solid fa-arrow-left text-xl"></i>
                        </button>
                        <h2 class="text-lg font-bold">配置教程</h2>
                    </div>
                    
                    <div class="flex-1 overflow-y-auto p-5 pb-safe space-y-6 lg:max-w-2xl lg:mx-auto lg:w-full">
                        <div class="space-y-4">
                            <div class="flex gap-4">
                                <div class="w-8 h-8 rounded-full bg-indigo-100 text-indigo-600 flex items-center justify-center font-bold shrink-0">1</div>
                                <div>
                                    <h3 class="font-bold text-slate-800 mb-1">访问 Firebase 控制台</h3>
                                    <p class="text-xs text-gray-500 leading-relaxed">
                                        在浏览器中打开 <a href="https://console.firebase.google.com/" target="_blank" class="text-indigo-500 underline">console.firebase.google.com</a> 并登录您的 Google 账号。
                                    </p>
                                </div>
                            </div>

                            <div class="flex gap-4">
                                <div class="w-8 h-8 rounded-full bg-indigo-100 text-indigo-600 flex items-center justify-center font-bold shrink-0">2</div>
                                <div>
                                    <h3 class="font-bold text-slate-800 mb-1">创建或选择项目</h3>
                                    <p class="text-xs text-gray-500 leading-relaxed">点击 "添加项目" (Add project) 或选择一个现有的项目进入。</p>
                                </div>
                            </div>

                            <div class="flex gap-4">
                                <div class="w-8 h-8 rounded-full bg-indigo-100 text-indigo-600 flex items-center justify-center font-bold shrink-0">3</div>
                                <div>
                                    <h3 class="font-bold text-slate-800 mb-1">进入项目设置</h3>
                                    <p class="text-xs text-gray-500 leading-relaxed">点击左上角的 <i class="fa-solid fa-gear text-gray-400"></i> 齿轮图标，选择 <strong>项目设置 (Project settings)</strong>。</p>
                                </div>
                            </div>

                            <div class="flex gap-4">
                                <div class="w-8 h-8 rounded-full bg-indigo-100 text-indigo-600 flex items-center justify-center font-bold shrink-0">4</div>
                                <div>
                                    <h3 class="font-bold text-slate-800 mb-1">注册 Web 应用</h3>
                                    <p class="text-xs text-gray-500 leading-relaxed">
                                        向下滚动到 "您的应用" (Your apps) 区域。如果没有应用，点击 <i class="fa-solid fa-code text-gray-400"></i> (Web) 图标来注册一个新应用（名称随意填写）。
                                    </p>
                                </div>
                            </div>

                            <div class="flex gap-4">
                                <div class="w-8 h-8 rounded-full bg-indigo-100 text-indigo-600 flex items-center justify-center font-bold shrink-0">5</div>
                                <div>
                                    <h3 class="font-bold text-slate-800 mb-1">复制配置代码</h3>
                                    <p class="text-xs text-gray-500 leading-relaxed mb-2">
                                        在 "SDK 设置与配置" 选项中，选择 <strong>Config</strong> (不是 CDN)。复制 <code>const firebaseConfig = { ... };</code> 大括号内的内容。
                                    </p>
                                    <div class="bg-slate-800 rounded-lg p-3 relative overflow-hidden">
                                        <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-indigo-500 to-purple-500"></div>
                                        <code class="text-[10px] text-gray-400 font-mono block">
                                            {<br>
                                            &nbsp;&nbsp;"apiKey": "AIza...",<br>
                                            &nbsp;&nbsp;"authDomain": "...",<br>
                                            &nbsp;&nbsp;"projectId": "...",<br>
                                            &nbsp;&nbsp;...<br>
                                            }
                                        </code>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <button @click="currentView = 'settings'" class="w-full py-3 bg-slate-100 text-slate-600 font-bold rounded-xl hover:bg-slate-200 transition-colors">
                            我已了解，返回配置
                        </button>
                    </div>
                </div>
            </transition>
        </main>

        <!-- Modals -->
        
        <!-- Add Student Modal -->
        <transition name="modal">
            <div v-if="showAddModal" class="absolute inset-0 z-50 bg-slate-900/40 backdrop-blur-sm flex items-end sm:items-center justify-center p-4">
                <div class="bg-white w-full max-w-xs rounded-3xl p-6 shadow-2xl mb-4 sm:mb-0" @click.stop>
                    <h3 class="text-xl font-bold mb-6 text-center text-slate-800">新增学员</h3>
                    <div class="bg-gray-50 p-2 rounded-xl mb-6 border border-gray-100 focus-within:border-indigo-500 focus-within:ring-2 ring-indigo-100 transition-all">
                        <label class="block text-xs text-gray-400 font-bold px-2 pt-1 uppercase">姓名</label>
                        <input v-model="newStudentName" ref="newStudentInput" type="text" class="w-full p-2 bg-transparent outline-none text-lg font-bold text-slate-800" placeholder="请输入姓名">
                    </div>
                    <div class="flex gap-3">
                        <button @click="showAddModal = false" class="flex-1 py-3 text-gray-500 hover:bg-gray-100 rounded-xl font-medium transition-colors">取消</button>
                        <button @click="addStudent" class="flex-1 py-3 bg-indigo-600 text-white rounded-xl font-bold shadow-lg shadow-indigo-200 hover:bg-indigo-700 transition-colors active:scale-95">确认添加</button>
                    </div>
                </div>
            </div>
        </transition>

        <!-- Edit Name Modal -->
        <transition name="modal">
            <div v-if="showEditModal" class="absolute inset-0 z-50 bg-slate-900/40 backdrop-blur-sm flex items-end sm:items-center justify-center p-4">
                <div class="bg-white w-full max-w-xs rounded-3xl p-6 shadow-2xl mb-4 sm:mb-0" @click.stop>
                    <h3 class="text-xl font-bold mb-6 text-center text-slate-800">修改姓名</h3>
                    <div class="bg-gray-50 p-2 rounded-xl mb-6 border border-gray-100 focus-within:border-indigo-500 focus-within:ring-2 ring-indigo-100 transition-all">
                        <label class="block text-xs text-gray-400 font-bold px-2 pt-1 uppercase">新姓名</label>
                        <input v-model="editingName" ref="editNameInput" type="text" class="w-full p-2 bg-transparent outline-none text-lg font-bold text-slate-800">
                    </div>
                    <div class="flex gap-3">
                        <button @click="showEditModal = false" class="flex-1 py-3 text-gray-500 hover:bg-gray-100 rounded-xl font-medium transition-colors">取消</button>
                        <button @click="saveName" class="flex-1 py-3 bg-indigo-600 text-white rounded-xl font-bold shadow-lg shadow-indigo-200 hover:bg-indigo-700 transition-colors active:scale-95">保存修改</button>
                    </div>
                </div>
            </div>
        </transition>

        <!-- Edit Log Modal -->
        <transition name="modal">
            <div v-if="showEditLogModal" class="absolute inset-0 z-50 bg-slate-900/40 backdrop-blur-sm flex items-end sm:items-center justify-center p-4">
                <div class="bg-white w-full max-w-xs rounded-3xl p-6 shadow-2xl mb-4 sm:mb-0" @click.stop>
                    <h3 class="text-xl font-bold mb-6 text-center text-slate-800">修改记录</h3>
                    
                    <div class="mb-4">
                        <label class="block text-xs text-gray-400 font-bold px-2 pt-1 uppercase mb-1">日期</label>
                        <div class="bg-gray-50 p-2 rounded-xl border border-gray-100 focus-within:ring-2 ring-indigo-100 transition-all">
                             <input v-model="editingLogData.date" type="date" class="w-full bg-transparent outline-none text-lg font-bold text-slate-700 text-center">
                        </div>
                    </div>

                    <div class="mb-4">
                        <label class="block text-xs text-gray-400 font-bold px-2 pt-1 uppercase mb-1">数量 (负数表示消耗)</label>
                        <div class="flex items-center justify-center gap-4 mb-2">
                             <button @click="editingLogData.amount--" class="w-10 h-10 rounded-full bg-gray-100 text-gray-500 hover:bg-gray-200 flex items-center justify-center text-lg font-bold transition-colors"><i class="fa-solid fa-minus"></i></button>
                             <!-- Optimized Input: inputmode numeric -->
                             <input v-model.number="editingLogData.amount" type="number" inputmode="numeric" class="w-24 text-center text-3xl font-black text-slate-700 border-b-2 border-indigo-100 focus:border-indigo-500 outline-none bg-transparent">
                             <button @click="editingLogData.amount++" class="w-10 h-10 rounded-full bg-gray-100 text-gray-500 hover:bg-gray-200 flex items-center justify-center text-lg font-bold transition-colors"><i class="fa-solid fa-plus"></i></button>
                        </div>
                    </div>
                    <div class="bg-gray-50 p-3 rounded-xl mb-6 focus-within:ring-2 ring-indigo-100 transition-all">
                        <input v-model="editingLogData.note" type="text" placeholder="备注" class="w-full bg-transparent outline-none text-sm text-slate-700 placeholder-gray-400 text-center">
                    </div>
                    <div class="flex gap-3">
                        <button @click="showEditLogModal = false" class="flex-1 py-3 text-gray-500 hover:bg-gray-100 rounded-xl font-medium transition-colors">取消</button>
                        <button @click="saveEditLog" class="flex-1 py-3 bg-indigo-600 text-white rounded-xl font-bold shadow-lg shadow-indigo-200 hover:bg-indigo-700 transition-colors active:scale-95">保存</button>
                    </div>
                </div>
            </div>
        </transition>

        <!-- Delete Log Confirmation Modal -->
        <transition name="modal">
            <div v-if="showDeleteLogModal" class="absolute inset-0 z-50 bg-slate-900/40 backdrop-blur-sm flex items-end sm:items-center justify-center p-4">
                <div class="bg-white w-full max-w-xs rounded-3xl p-6 shadow-2xl mb-4 sm:mb-0" @click.stop>
                    <div class="text-center mb-6">
                        <div class="w-16 h-16 bg-rose-50 rounded-full flex items-center justify-center mx-auto mb-4">
                            <i class="fa-solid fa-triangle-exclamation text-2xl text-rose-500"></i>
                        </div>
                        <h3 class="text-xl font-bold text-slate-800 mb-2">确认删除?</h3>
                        <p class="text-sm text-gray-500">删除此记录后，学生余额将自动回调。此操作无法撤销。</p>
                    </div>
                    <div class="flex gap-3">
                        <button @click="showDeleteLogModal = false" class="flex-1 py-3 text-gray-500 hover:bg-gray-100 rounded-xl font-medium transition-colors">取消</button>
                        <button @click="confirmDeleteLog" class="flex-1 py-3 bg-rose-500 text-white rounded-xl font-bold shadow-lg shadow-rose-200 hover:bg-rose-600 transition-colors active:scale-95">删除</button>
                    </div>
                </div>
            </div>
        </transition>

        <!-- Delete Student Confirmation Modal (NEW) -->
        <transition name="modal">
            <div v-if="showDeleteStudentModal" class="absolute inset-0 z-50 bg-slate-900/40 backdrop-blur-sm flex items-end sm:items-center justify-center p-4">
                <div class="bg-white w-full max-w-xs rounded-3xl p-6 shadow-2xl mb-4 sm:mb-0" @click.stop>
                    <div class="text-center mb-6">
                        <div class="w-16 h-16 bg-rose-50 rounded-full flex items-center justify-center mx-auto mb-4">
                            <i class="fa-solid fa-user-xmark text-2xl text-rose-500"></i>
                        </div>
                        <h3 class="text-xl font-bold text-slate-800 mb-2">删除学员?</h3>
                        <p class="text-sm text-gray-500">确定要删除学员 <span class="font-bold text-slate-800">{{ studentToDelete?.name }}</span> 吗？<br>此操作将清除该学员的所有课时记录，且无法恢复。</p>
                    </div>
                    <div class="flex gap-3">
                        <button @click="showDeleteStudentModal = false" class="flex-1 py-3 text-gray-500 hover:bg-gray-100 rounded-xl font-medium transition-colors">取消</button>
                        <button @click="confirmDeleteStudent" class="flex-1 py-3 bg-rose-500 text-white rounded-xl font-bold shadow-lg shadow-rose-200 hover:bg-rose-600 transition-colors active:scale-95">确认删除</button>
                    </div>
                </div>
            </div>
        </transition>

        <!-- Permission Error Modal (Fix for Missing Permissions) -->
        <transition name="modal">
            <div v-if="showPermissionErrorModal" class="absolute inset-0 z-[60] bg-slate-900/60 backdrop-blur-sm flex items-center justify-center p-4">
                <div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl" @click.stop>
                    <div class="flex items-center gap-3 mb-4 text-amber-500">
                        <i class="fa-solid fa-shield-halved text-2xl"></i>
                        <h3 class="text-xl font-bold text-slate-800">数据库权限不足</h3>
                    </div>
                    
                    <p class="text-sm text-gray-600 leading-relaxed mb-4">
                        您的 Firebase 数据库默认处于锁定状态。为了使用本应用，请修改 Firestore 规则以允许读写（测试模式）。
                    </p>
                    
                    <div class="bg-slate-50 p-3 rounded-xl border border-gray-200 mb-4">
                        <div class="text-[10px] text-gray-400 uppercase font-bold mb-1">请复制以下规则:</div>
                        <code class="block text-[10px] font-mono text-slate-700 whitespace-pre overflow-x-auto select-all">
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /{document=**} {
      allow read, write: if true;
    }
  }
}
                        </code>
                    </div>

                    <p class="text-xs text-gray-400 mb-6">
                        前往：Firebase Console -> Firestore Database -> Rules (规则) 标签页，粘贴并发布。
                    </p>

                    <button @click="showPermissionErrorModal = false" class="w-full py-3 bg-amber-500 text-white rounded-xl font-bold shadow-lg shadow-amber-200 hover:bg-amber-600 transition-colors active:scale-95">
                        我已修改，重试
                    </button>
                </div>
            </div>
        </transition>

        <!-- Recharge Modal -->
        <transition name="modal">
            <div v-if="showRechargeModal" class="absolute inset-0 z-50 bg-slate-900/40 backdrop-blur-sm flex items-end sm:items-center justify-center p-4">
                <div class="bg-white w-full max-w-xs rounded-3xl p-6 shadow-2xl mb-4 sm:mb-0" @click.stop>
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl font-bold text-slate-800">预付课时</h3>
                        <div class="px-2 py-1 bg-emerald-100 text-emerald-600 rounded-lg text-xs font-bold">余额: {{ currentStudent?.balance }}</div>
                    </div>
                    
                    <div class="mb-4">
                        <div class="flex items-center justify-center gap-4 mb-2">
                            <button @click="rechargeAmount = Math.max(1, rechargeAmount - 1)" class="w-10 h-10 rounded-full bg-gray-100 text-gray-500 hover:bg-gray-200 flex items-center justify-center text-lg font-bold transition-colors"><i class="fa-solid fa-minus"></i></button>
                            <!-- Optimized Input: Fixed height h-16 to prevent clipping of text-4xl -->
                            <input v-model.number="rechargeAmount" type="number" inputmode="numeric" class="w-24 h-16 text-center text-4xl font-black text-emerald-600 border-b-2 border-emerald-100 focus:border-emerald-500 outline-none bg-transparent">
                            <button @click="rechargeAmount++" class="w-10 h-10 rounded-full bg-gray-100 text-gray-500 hover:bg-gray-200 flex items-center justify-center text-lg font-bold transition-colors"><i class="fa-solid fa-plus"></i></button>
                        </div>
                        <p class="text-center text-xs text-gray-400 mb-2">充值数量</p>
                        
                        <!-- Quick Select -->
                        <div class="flex justify-center gap-2 mb-4">
                             <button @click="rechargeAmount = 10" class="px-3 py-1 rounded-full bg-emerald-50 text-emerald-600 text-xs font-bold border border-emerald-100 hover:bg-emerald-100 transition-colors">10课时</button>
                             <button @click="rechargeAmount = 20" class="px-3 py-1 rounded-full bg-emerald-50 text-emerald-600 text-xs font-bold border border-emerald-100 hover:bg-emerald-100 transition-colors">20课时</button>
                             <button @click="rechargeAmount = 50" class="px-3 py-1 rounded-full bg-emerald-50 text-emerald-600 text-xs font-bold border border-emerald-100 hover:bg-emerald-100 transition-colors">50课时</button>
                        </div>
                    </div>
                    
                    <div class="bg-gray-50 p-3 rounded-xl mb-6 focus-within:ring-2 ring-emerald-100 transition-all">
                        <input v-model="rechargeNote" type="text" placeholder="备注 (选填，例如: 续费)" class="w-full bg-transparent outline-none text-sm text-slate-700 placeholder-gray-400 text-center">
                    </div>
                    
                    <div class="flex gap-3">
                        <button @click="showRechargeModal = false" class="flex-1 py-3 text-gray-500 hover:bg-gray-100 rounded-xl font-medium transition-colors">取消</button>
                        <button @click="confirmRecharge" class="flex-1 py-3 bg-emerald-500 text-white rounded-xl font-bold shadow-lg shadow-emerald-200 hover:bg-emerald-600 transition-colors active:scale-95">确认充值</button>
                    </div>
                </div>
            </div>
        </transition>

    </div>

    <script type="module">
        // Dynamic import logic is handled inside setup/initFirebase to prevent top-level await issues or blocking
        const { createApp, ref, computed, onMounted, watch, nextTick } = Vue;

        createApp({
            setup() {
                // --- State ---
                const currentView = ref('list'); // list, detail, settings
                const students = ref([]);
                const currentStudent = ref(null);
                const searchQuery = ref('');
                
                // Modal States
                const showAddModal = ref(false);
                const showEditModal = ref(false);
                const showRechargeModal = ref(false);
                const showEditLogModal = ref(false);
                const showDeleteLogModal = ref(false);
                const showDeleteStudentModal = ref(false);
                const showPermissionErrorModal = ref(false); // NEW: Permission Error Modal
                
                // Form Inputs
                const newStudentName = ref('');
                const editingName = ref('');
                const rechargeAmount = ref(10);
                const rechargeNote = ref('');
                const firebaseConfigInput = ref('');
                
                // Log Editing/Deleting State
                const editingLog = ref(null); 
                const editingLogData = ref({ amount: 0, note: '', date: '' });
                const logToDelete = ref(null);
                const studentToDelete = ref(null); 
                
                // System Status
                const isOnline = ref(false);
                const notification = ref({ show: false, message: '', type: 'success' });
                
                // Refs for focus
                const newStudentInput = ref(null);
                const editNameInput = ref(null);
                
                // Firestore Instance (Loaded dynamically)
                let db = null;
                const COLLECTION_NAME = 'students';
                
                // Firebase modules (Loaded dynamically)
                let _initializeApp, _getFirestore, _collection, _doc, _setDoc, _getDocs, _updateDoc, _deleteDoc;

                // --- Persistence & Init ---
                onMounted(async () => {
                    loadLocalConfig();
                    loadLocalData();
                    
                    // Attempt to restore last active student
                    const lastStudentId = localStorage.getItem('class_manager_last_student');
                    if (lastStudentId && students.value.length > 0) {
                        const found = students.value.find(s => s.id === lastStudentId);
                        if (found) {
                            selectStudent(found);
                        }
                    }

                    if (firebaseConfigInput.value) {
                        // Optimistically try to parse stored config if it exists
                        try {
                            const cfg = JSON.parse(firebaseConfigInput.value);
                            await initFirebase(cfg);
                        } catch(e) { /* Ignore malformed local config on boot */ }
                    }
                });

                // --- Actions: Config ---
                const loadLocalConfig = () => {
                    const cfg = localStorage.getItem('class_manager_config');
                    if (cfg) firebaseConfigInput.value = cfg;
                };

                const saveConfig = async () => {
                    const rawInput = firebaseConfigInput.value.trim();
                    if (!rawInput) return;
                    
                    try {
                        // Helper to parse leniently
                        let configStr = rawInput;
                        
                        // Extract object if user pasted "const firebaseConfig = { ... };"
                        const firstBrace = configStr.indexOf('{');
                        const lastBrace = configStr.lastIndexOf('}');
                        if (firstBrace !== -1 && lastBrace !== -1) {
                            configStr = configStr.substring(firstBrace, lastBrace + 1);
                        }

                        let config;
                        try {
                            // Try strict JSON first
                            config = JSON.parse(configStr);
                        } catch (jsonErr) {
                            // Fallback to JS object evaluation (handles unquoted keys, trailing commas)
                            // Note: This is client-side input from the user, so risk is low/acceptable for this context
                            config = new Function('return ' + configStr)();
                        }

                        if (!config || !config.apiKey) {
                            throw new Error('Invalid Config Object');
                        }

                        // Store the *stringified* version for consistency if it was JS object
                        localStorage.setItem('class_manager_config', JSON.stringify(config));
                        
                        // Re-initialize
                        await initFirebase(config);
                        
                        showToast('配置保存成功，正在连接云端...', 'success');
                        await syncFromCloud();
                    } catch (e) {
                        showToast('配置格式错误: 请确保包含 { ... }', 'error');
                        console.error("Config Parse Error", e);
                    }
                };
                
                const clearConfig = () => {
                    localStorage.removeItem('class_manager_config');
                    firebaseConfigInput.value = '';
                    isOnline.value = false;
                    db = null;
                    showToast('配置已清除，切换为本地模式', 'success');
                };

                const initFirebase = async (config) => {
                    try {
                        // Dynamic Import to fail gracefully if offline/blocked
                        const appModule = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js');
                        const firestoreModule = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
                        
                        _initializeApp = appModule.initializeApp;
                        _getFirestore = firestoreModule.getFirestore;
                        _collection = firestoreModule.collection;
                        _doc = firestoreModule.doc;
                        _setDoc = firestoreModule.setDoc;
                        _getDocs = firestoreModule.getDocs;
                        _updateDoc = firestoreModule.updateDoc;
                        _deleteDoc = firestoreModule.deleteDoc;

                        const app = _initializeApp(config);
                        db = _getFirestore(app);
                        isOnline.value = true;
                    } catch (e) {
                        console.error("Firebase Init Error", e);
                        isOnline.value = false;
                        showToast('无法连接 Firebase (可能被拦截)', 'error');
                    }
                };

                // --- Helper: Central Error Handler ---
                const handleFirebaseError = (e) => {
                    console.error("Firebase Error", e);
                    if (e.code === 'permission-denied' || e.message?.includes('Missing or insufficient permissions')) {
                        showPermissionErrorModal.value = true;
                        showToast('权限不足: 请检查 Firestore 规则', 'error');
                    } else {
                        showToast('操作失败: ' + (e.message || '未知错误'), 'error');
                    }
                }

                // --- Actions: Data Sync Strategy ---
                const loadLocalData = () => {
                    const localData = localStorage.getItem('class_manager_data');
                    if (localData) {
                        students.value = JSON.parse(localData);
                    }
                };

                const saveLocalData = () => {
                    localStorage.setItem('class_manager_data', JSON.stringify(students.value));
                };

                // Sync: Cloud -> Local (Priority)
                const syncFromCloud = async () => {
                    if (!db) return;
                    try {
                        const querySnapshot = await _getDocs(_collection(db, COLLECTION_NAME));
                        const cloudStudents = [];
                        querySnapshot.forEach((doc) => {
                            cloudStudents.push(doc.data());
                        });
                        if (cloudStudents.length > 0) {
                            students.value = cloudStudents;
                            saveLocalData();
                            
                            // If we have a current student selected, update their reference
                            if (currentStudent.value) {
                                const found = students.value.find(s => s.id === currentStudent.value.id);
                                if (found) currentStudent.value = found;
                            }
                            
                            showToast('已同步云端数据', 'success');
                        }
                    } catch (e) {
                        handleFirebaseError(e);
                    }
                };

                // Sync: Local -> Cloud (Individual Update)
                const upsertStudentToCloud = async (student) => {
                    if (!db) return;
                    try {
                        await _setDoc(_doc(db, COLLECTION_NAME, student.id), student);
                    } catch (e) {
                        handleFirebaseError(e);
                    }
                };

                const deleteStudentFromCloud = async (id) => {
                    if (!db) return;
                    try {
                        await _deleteDoc(_doc(db, COLLECTION_NAME, id));
                    } catch (e) {
                        handleFirebaseError(e);
                    }
                }

                const forceSyncToCloud = async () => {
                    if(!db) return showToast('未配置云端数据库', 'error');
                    let count = 0;
                    try {
                        for(const s of students.value) {
                            await _setDoc(_doc(db, COLLECTION_NAME, s.id), s);
                            count++;
                        }
                        showToast(`成功上传 ${count} 条数据到云端`, 'success');
                    } catch (e) {
                        handleFirebaseError(e);
                    }
                };

                // --- Actions: Business Logic ---
                const addStudent = async () => {
                    if (!newStudentName.value.trim()) return;
                    
                    const newId = Date.now().toString();
                    const newStudent = {
                        id: newId,
                        name: newStudentName.value,
                        balance: 0,
                        logs: [{
                            amount: 0,
                            timestamp: Date.now(),
                            note: '创建账户'
                        }]
                    };
                    
                    students.value.unshift(newStudent);
                    saveLocalData();
                    upsertStudentToCloud(newStudent);
                    
                    newStudentName.value = '';
                    showAddModal.value = false;
                    selectStudent(newStudent); // Auto select new student
                    showToast(`已添加学生: ${newStudent.name}`, 'success');
                };

                const selectStudent = (student) => {
                    currentStudent.value = student; 
                    currentView.value = 'detail';
                    localStorage.setItem('class_manager_last_student', student.id);
                };

                // Rename Logic
                const startEditName = () => {
                    if(!currentStudent.value) return;
                    editingName.value = currentStudent.value.name;
                    showEditModal.value = true;
                };

                const saveName = () => {
                    if(!editingName.value.trim() || !currentStudent.value) return;
                    
                    const oldName = currentStudent.value.name;
                    const student = students.value.find(s => s.id === currentStudent.value.id);
                    if(student) {
                        student.name = editingName.value;
                        // Mutate current student reference immediately for UI
                        currentStudent.value.name = editingName.value; 
                        
                        saveLocalData();
                        upsertStudentToCloud(student);
                        
                        showEditModal.value = false;
                        showToast('姓名修改成功', 'success');
                    }
                };

                const updateCurrentStudent = (actionType, amount, note = '') => {
                    if (!currentStudent.value) return;
                    
                    const student = students.value.find(s => s.id === currentStudent.value.id);
                    if (!student) return;

                    // Update Balance
                    student.balance += amount;
                    
                    // Add Log
                    student.logs.push({
                        amount: amount,
                        timestamp: Date.now(),
                        note: note || (amount < 0 ? `消课 ${Math.abs(amount)} 节` : '充值')
                    });

                    // Persist
                    saveLocalData();
                    upsertStudentToCloud(student);
                    
                    showToast(amount > 0 ? '充值成功' : '消课成功', 'success');
                };

                const confirmRecharge = () => {
                    if (!rechargeAmount.value) return;
                    updateCurrentStudent('recharge', rechargeAmount.value, rechargeNote.value || '手动充值');
                    showRechargeModal.value = false;
                    rechargeAmount.value = 10;
                    rechargeNote.value = '';
                };

                const consumeClass = (count) => {
                    if (currentStudent.value.balance < count) {
                        showToast('余额不足，无法消课', 'error');
                        return;
                    }
                    const note = count + '小时'; 
                    updateCurrentStudent('consume', -count, note);
                };

                // Log Editing Logic
                const openEditLog = (log) => {
                    editingLog.value = log;
                    // Format date for input type="date"
                    const dateObj = new Date(log.timestamp);
                    const yyyy = dateObj.getFullYear();
                    const mm = String(dateObj.getMonth() + 1).padStart(2, '0');
                    const dd = String(dateObj.getDate()).padStart(2, '0');
                    
                    editingLogData.value = { 
                        amount: log.amount, 
                        note: log.note || '',
                        date: `${yyyy}-${mm}-${dd}`
                    };
                    showEditLogModal.value = true;
                };

                const saveEditLog = () => {
                    if (!editingLog.value || !currentStudent.value) return;
                    
                    const student = students.value.find(s => s.id === currentStudent.value.id);
                    
                    // FIX: Find actual log reference in array by timestamp
                    // editingLog.value is a copy from sortedLogs, so strict equality failed.
                    const logIndex = student.logs.findIndex(l => l.timestamp === editingLog.value.timestamp);
                    
                    if (logIndex === -1) {
                         showToast('保存失败: 找不到原始记录', 'error');
                         return;
                    }

                    // Update timestamp from date input if provided
                    if (editingLogData.value.date) {
                        const originalTs = new Date(student.logs[logIndex].timestamp);
                        // Apply new date parts, preserve original time
                        const [y, m, d] = editingLogData.value.date.split('-').map(Number);
                        originalTs.setFullYear(y);
                        originalTs.setMonth(m - 1);
                        originalTs.setDate(d);
                        student.logs[logIndex].timestamp = originalTs.getTime();
                    }

                    const oldAmount = student.logs[logIndex].amount;
                    const newAmount = editingLogData.value.amount;
                    const diff = newAmount - oldAmount;

                    // Update balance
                    student.balance += diff;
                    
                    // Update log details
                    student.logs[logIndex].amount = newAmount;
                    student.logs[logIndex].note = editingLogData.value.note;

                    saveLocalData();
                    upsertStudentToCloud(student);
                    
                    showEditLogModal.value = false;
                    showToast('记录修改成功', 'success');
                };

                const promptDeleteLog = (log) => {
                    logToDelete.value = log;
                    showDeleteLogModal.value = true;
                };

                const confirmDeleteLog = () => {
                    if (!currentStudent.value || !logToDelete.value) {
                         showDeleteLogModal.value = false;
                         return;
                    }

                    const student = students.value.find(s => s.id === currentStudent.value.id);
                    
                    // Robust find: try reference first, then properties
                    let logIndex = student.logs.findIndex(l => l.timestamp === logToDelete.value.timestamp);
                    if (logIndex === -1) {
                         // Fallback
                         logIndex = student.logs.findIndex(l => l.timestamp === logToDelete.value.timestamp && l.amount === logToDelete.value.amount);
                    }

                    if (logIndex !== -1) {
                        // Revert balance
                        student.balance -= logToDelete.value.amount;
                        // Remove log
                        student.logs.splice(logIndex, 1);

                        saveLocalData();
                        upsertStudentToCloud(student);
                        showToast('记录已删除', 'success');
                    } else {
                        showToast('删除失败: 未找到记录', 'error');
                    }
                    
                    showDeleteLogModal.value = false;
                    logToDelete.value = null;
                };

                // NEW: Open Modal Action
                const openDeleteStudentModal = (student) => {
                    studentToDelete.value = student;
                    showDeleteStudentModal.value = true;
                };

                // NEW: Confirm Delete Action
                const confirmDeleteStudent = () => {
                    if (!studentToDelete.value) return;
                    const student = studentToDelete.value;
                    const id = student.id;

                    students.value = students.value.filter(s => s.id !== id);
                    saveLocalData();
                    deleteStudentFromCloud(id);
                    
                    // If deleting currently selected student
                    if (currentStudent.value && currentStudent.value.id === id) {
                        currentStudent.value = null;
                        localStorage.removeItem('class_manager_last_student');
                        currentView.value = 'list';
                    }
                    
                    showDeleteStudentModal.value = false;
                    studentToDelete.value = null;
                    showToast('学生已删除', 'success');
                };

                // Legacy fallback if called from other places
                const deleteStudentConfirm = () => {
                   if (currentStudent.value) openDeleteStudentModal(currentStudent.value);
                };

                const resetAllData = () => {
                    if(confirm('警告：将清空所有本地数据！确定吗？')) {
                        localStorage.removeItem('class_manager_data');
                        localStorage.removeItem('class_manager_last_student');
                        students.value = [];
                        currentView.value = 'list';
                        showToast('本地数据已重置', 'success');
                    }
                }

                // --- Helpers & Computed ---
                const filteredStudents = computed(() => {
                    if (!searchQuery.value) return students.value;
                    return students.value.filter(s => s.name.toLowerCase().includes(searchQuery.value.toLowerCase()));
                });

                const sortedLogs = computed(() => {
                    if (!currentStudent.value || !currentStudent.value.logs) return [];
                    
                    // 1. Sort ascending first to calculate running balance
                    const ascending = [...currentStudent.value.logs].sort((a, b) => a.timestamp - b.timestamp);
                    
                    // 2. Calculate balance snapshot
                    let runningBalance = 0;
                    const withBalance = ascending.map(log => {
                        runningBalance += log.amount;
                        return { ...log, snapshotBalance: runningBalance };
                    });
                    
                    // 3. Reverse for display (Newest first)
                    return withBalance.reverse();
                });

                const getLastActivity = (student) => {
                    if (!student.logs || student.logs.length === 0) return '无记录';
                    const lastLog = student.logs[student.logs.length - 1];
                    return formatTime(lastLog.timestamp);
                };

                const formatTime = (ts) => {
                    const d = new Date(ts);
                    // Simple formatter: MM/DD HH:mm
                    const m = (d.getMonth() + 1).toString().padStart(2, '0');
                    const day = d.getDate().toString().padStart(2, '0');
                    const h = d.getHours().toString().padStart(2, '0');
                    const min = d.getMinutes().toString().padStart(2, '0');
                    return `${m}/${day} ${h}:${min}`;
                };

                const getBalanceColor = (balance) => {
                    if (balance <= 2) return 'text-amber-500'; // Warning
                    return 'text-indigo-600'; // Good
                };

                const showToast = (msg, type = 'success') => {
                    notification.value = { show: true, message: msg, type };
                    setTimeout(() => {
                        notification.value.show = false;
                    }, 3000);
                };

                const toggleSettings = () => {
                    if (currentView.value === 'settings') {
                        // Go back to where we were
                        const lastId = localStorage.getItem('class_manager_last_student');
                        if (lastId && students.value.find(s => s.id === lastId)) {
                             currentView.value = 'detail';
                        } else {
                             currentView.value = 'list';
                        }
                    } else {
                        currentView.value = 'settings';
                    }
                };

                // Auto Focus Logic
                watch(showAddModal, async (val) => {
                    if (val) {
                        await nextTick();
                        newStudentInput.value?.focus();
                    }
                });
                
                watch(showEditModal, async (val) => {
                    if (val) {
                        await nextTick();
                        editNameInput.value?.focus();
                    }
                });

                return {
                    currentView, students, currentStudent, searchQuery, 
                    showAddModal, showEditModal, showRechargeModal, showEditLogModal, showDeleteLogModal, showDeleteStudentModal, showPermissionErrorModal,
                    newStudentName, editingName, rechargeAmount, rechargeNote,
                    firebaseConfigInput, isOnline, notification, 
                    newStudentInput, editNameInput, editingLogData, studentToDelete,
                    addStudent, selectStudent, confirmRecharge, consumeClass,
                    startEditName, saveName, openEditLog, saveEditLog, promptDeleteLog, confirmDeleteLog,
                    saveConfig, clearConfig, filteredStudents, sortedLogs,
                    getLastActivity, formatTime, getBalanceColor, toggleSettings,
                    deleteStudentConfirm, openDeleteStudentModal, confirmDeleteStudent, forceSyncToCloud, resetAllData
                };
            }
        }).mount('#app');
    </script>
</body>
</html>